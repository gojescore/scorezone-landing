<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minus Hjælper</title>
  <style>
    :root{
      --bg:#f6f3ee;
      --panel:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#2563eb;
      --good:#16a34a;
      --bad:#dc2626;
      --coin:#f4b000;
      --coin2:#f7c948;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    h1{font-size:20px;margin:0}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:14px;}
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fafafa;
    }
    .stars{display:inline-flex;gap:2px;font-size:16px;line-height:1;}
    .stars .off{opacity:.22}

    button{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      background:var(--accent);
      color:white;
    }
    button.secondary{background:#111827;}
    button:disabled{opacity:.5;cursor:not-allowed;}

    /* Setup */
    #setup{display:grid;gap:12px;max-width:560px;margin:34px auto;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-weight:600}
    input[type="text"], select{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      font-size:16px;
      outline:none;
      min-width:220px;
      background:white;
    }
    .help{color:var(--muted);font-size:14px;line-height:1.35;}

    /* App layout */
    .layout{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    .board{display:grid;gap:12px;}
    .panel{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      background:#fcfcfc;
    }

    /* Arithmetic */
    .arith{
      display:grid;
      grid-template-columns: 44px 1fr;
      gap:12px;
      align-items:start;
    }
    .op{
      font-size:28px;
      font-weight:900;
      padding-top:18px;
      text-align:center;
    }
    .digits{
      display:grid;
      grid-template-columns: 36px 64px 64px; /* spacer/marks + tens + ones */
      column-gap:10px;
      row-gap:8px;
      align-items:center;
    }
    .borrowMark{
      height:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      color:#111827;
      opacity:.85;
    }
    .numCell{
      height:52px;
      border:1px solid var(--line);
      border-radius:12px;
      background:white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
      font-weight:900;
      position:relative;
    }
    .numCell.small{height:44px;font-size:24px;font-weight:850;}
    /* Strike tens digit on borrow */
    .numCell.struck::after{
      content:"";
      position:absolute;
      width:125%;
      height:5px;
      background: rgba(220,38,38,.92);
      border-radius: 999px;
      transform: rotate(-18deg);
    }

    .line{
      grid-column: 2 / 4;
      height:2px;
      background:#111827;
      border-radius:999px;
      margin-top:2px;
      margin-bottom:2px;
    }

    .inputs{
      display:grid;
      grid-template-columns: 36px 64px 64px;
      column-gap:10px;
      align-items:center;
      margin-top:8px;
    }
    .digitInput{
      width:64px;
      height:50px;
      font-size:22px;
      font-weight:800;
      text-align:center;
      border:2px solid var(--line);
      border-radius:12px;
      outline:none;
      background:white;
    }
    .digitInput:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(37,99,235,.14);
    }

    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .note{font-size:13px;color:var(--muted);}

    /* Coins aligned under columns */
    .coinsGrid{
      display:grid;
      grid-template-columns: 36px 1fr 1fr;
      gap:10px;
      align-items:start;
    }
    .coinCol{
      border:1px dashed #d1d5db;
      border-radius:14px;
      background:#fff;
      padding:10px;
      min-height:160px;
    }
    .coinColHeader{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom:6px;
      gap:10px;
    }
    .coinColHeader strong{font-size:13px}
    .coinColHeader span{font-size:12px;color:var(--muted)}

    /* Grid layout so coins spread out */
    .pile{
      display:grid;
      grid-template-columns: repeat(5, 40px);
      gap:8px;
      align-items:start;
      justify-content:start;
      align-content:start;
      min-height: 88px;
    }

    .coin{
      width:34px;
      height:34px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 25%, var(--coin2), var(--coin));
      border:2px solid rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#111827;
      user-select:none;
      cursor:pointer;
      position:relative;
    }
    .coin.tens{width:40px;height:40px;font-size:14px;}
    .coin.ones{font-size:14px;}
    .coin.crossed{
      opacity:.35;
      filter: grayscale(1);
    }
    .coin.crossed::after{
      content:"";
      position:absolute;
      width:120%;
      height:4px;
      background: rgba(220,38,38,.9);
      transform: rotate(-24deg);
      border-radius:999px;
    }
    .coin[draggable="true"]{cursor:grab;}
    .coin:active{transform:scale(.98)}

    /* Flying coins are temporary animation props */
    .flying-coin{
      position:absolute;
      z-index: 10000;
      pointer-events: none;
      will-change: transform;
    }

    /* Bank */
    .bankPanel{
      border:1px solid var(--line);
      border-radius:14px;
      background:#0b1224;
      color:#fff;
      padding:14px;
      display:grid;
      gap:10px;
      position: sticky;
      top: 14px;
    }
    .bankPanel h2{margin:0;font-size:16px;}
    .bankBox{
      border:2px dashed rgba(255,255,255,.35);
      border-radius:14px;
      min-height:170px;
      padding:10px;
      display:grid;
      gap:8px;
    }
    .bankBox.dragover{
      outline:3px solid rgba(37,99,235,.55);
      outline-offset:2px;
    }
    .bankRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .bankHint{font-size:13px;opacity:.9;line-height:1.3;}
    .bankStatus{font-size:12px;opacity:.85;}
    .bankSlot{
      border:1px solid rgba(255,255,255,.22);
      border-radius:14px;
      padding:10px;
      min-height:74px;
      background:rgba(255,255,255,.06);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:center;
    }
    .tinyNote{font-size:12px;color:rgba(255,255,255,.78);line-height:1.35;}

    /* Result overlay */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      padding:16px;
      display:grid;
      gap:10px;
    }
    .modal h3{margin:0;font-size:18px;}
    .modal .mtext{color:var(--muted);font-size:14px;line-height:1.35;}
    .modal .good{color:var(--good);font-weight:900;}
    .modal .bad{color:var(--bad);font-weight:900;}
    .modal .btnRow{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}

    .hidden{display:none !important;}

    /* Topbar level switch UI */
    .lvlSel{
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--line);
      font-weight:800;
      background:#fff;
      min-width:64px;
    }
    .miniBtn{
      padding:6px 10px;
      border-radius:10px;
      background:var(--accent);
      font-size:14px;
      font-weight:900;
    }

    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr;}
      .bankPanel{position: static;}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- SETUP -->
    <div id="setup" class="card">
      <h1>Minus Hjælper</h1>
      <div class="help">
        Elever vælger niveau og skriver navn. Herefter løses minus-opgaver (maks 99) med mønter og bank (veksling).
      </div>

      <div class="row">
        <label for="studentName">Navn</label>
        <input id="studentName" type="text" placeholder="Skriv dit navn" autocomplete="off" />
      </div>

      <div class="row">
        <label for="level">Start-niveau</label>
        <select id="level">
          <option value="1">Niveau 1 (ingen lån)</option>
          <option value="2">Niveau 2 (lån muligt, tal2 ≥ 23)</option>
          <option value="3">Niveau 3 (lån muligt, tal2 ≥ 23)</option>
        </select>
      </div>

      <div class="row">
        <button id="startBtn">Start</button>
      </div>

      <div class="help">
        Regler: resultat aldrig negativt, tal1 mindst 23, ingen tal over 99, samme opgave må ikke komme 2 gange i træk.
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="topbar">
        <h1>Minus Hjælper</h1>

        <div class="meta">
          <span class="badge"><strong id="who">—</strong></span>

          <span class="badge">
            Niveau:
            <select id="levelInGame" class="lvlSel" aria-label="Skift niveau">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <button id="applyLevelBtn" class="miniBtn" type="button">Skift</button>
          </span>

          <span class="badge">Streak: <strong id="streak">0</strong></span>
          <span class="badge">Stjerner: <span class="stars" id="stars"></span></span>

          <button class="secondary" id="newStudentBtn" type="button">Ny elev</button>
        </div>
      </div>

      <div class="layout">
        <!-- LEFT -->
        <div class="board">

          <div class="panel">
            <div class="arith">
              <div class="op">−</div>

              <div>
                <div class="digits">
                  <div class="borrowMark"></div>
                  <div class="borrowMark" id="borrowTensMark"></div>
                  <div class="borrowMark" id="borrowOnesMark"></div>

                  <div class="borrowMark"></div>
                  <div class="numCell" id="aTens">0</div>
                  <div class="numCell" id="aOnes">0</div>

                  <div class="borrowMark"></div>
                  <div class="numCell small" id="bTens">0</div>
                  <div class="numCell small" id="bOnes">0</div>

                  <div class="line"></div>

                  <div class="inputs">
                    <div></div>
                    <input class="digitInput" id="ansTens" inputmode="numeric" maxlength="1" aria-label="Ti'ere" />
                    <input class="digitInput" id="ansOnes" inputmode="numeric" maxlength="1" aria-label="Enere" />
                  </div>
                </div>

                <div class="actions">
                  <div class="note">Tip: Enter virker også som “Svar”.</div>
                  <button id="answerBtn" type="button" disabled>Svar</button>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="coinsGrid">
              <div></div>

              <div class="coinCol">
                <div class="coinColHeader">
                  <strong>Ti'ere (tal 1)</strong>
                  <span id="tensCount">0 stk</span>
                </div>
                <div class="pile" id="tensPile"></div>
              </div>

              <div class="coinCol">
                <div class="coinColHeader">
                  <strong>Enere (tal 1)</strong>
                  <span id="onesCount">0 stk</span>
                </div>
                <div class="pile" id="onesPile"></div>
              </div>
            </div>

            <div class="note" style="margin-top:10px">
              Tryk på mønter for at krydse ud. Træk en 10'er til banken og tryk "Veksel" for at låne.
            </div>
          </div>

        </div>

        <!-- RIGHT -->
        <div class="bankPanel">
          <h2>Bank</h2>

          <div class="bankBox" id="bankDrop">
            <div class="bankHint"><strong>Trin 1:</strong> Træk én 10'er herind (den bliver i banken).</div>

            <div class="bankSlot" id="bankSlot" aria-label="Bank slot"></div>

            <div class="bankRow">
              <button id="exchangeBtn" type="button" disabled>Veksel</button>
              <div class="bankStatus" id="bankStatus">Ingen veksling endnu.</div>
            </div>

            <div class="tinyNote" id="bankRules">
              Veksling kan kun ske én gang pr. opgave og kun hvis der er behov for lån (enere).
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- RESULT OVERLAY -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">—</h3>
      <div class="mtext" id="modalText">—</div>
      <div class="mtext" id="modalSub">—</div>
      <div class="btnRow">
        <button class="secondary" id="modalBtn" type="button">Næste</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const setup = $("setup");
  const app = $("app");
  const studentNameEl = $("studentName");
  const levelEl = $("level");
  const startBtn = $("startBtn");

  const whoEl = $("who");
  const streakEl = $("streak");
  const starsEl = $("stars");
  const newStudentBtn = $("newStudentBtn");

  const levelInGameEl = $("levelInGame");
  const applyLevelBtn = $("applyLevelBtn");

  const aTensEl = $("aTens");
  const aOnesEl = $("aOnes");
  const bTensEl = $("bTens");
  const bOnesEl = $("bOnes");
  const borrowOnesMarkEl = $("borrowOnesMark");

  const ansTensEl = $("ansTens");
  const ansOnesEl = $("ansOnes");

  const tensCountEl = $("tensCount");
  const onesCountEl = $("onesCount");
  const tensPileEl = $("tensPile");
  const onesPileEl = $("onesPile");

  const bankDropEl = $("bankDrop");
  const bankSlotEl = $("bankSlot");
  const exchangeBtn = $("exchangeBtn");
  const bankStatusEl = $("bankStatus");
  const bankRulesEl = $("bankRules");

  const answerBtn = $("answerBtn");

  const overlayEl = $("overlay");
  const modalTitleEl = $("modalTitle");
  const modalTextEl = $("modalText");
  const modalSubEl = $("modalSub");
  const modalBtn = $("modalBtn");

  const state = {
    studentName: "",
    level: 1,

    // Per-level streak/stars (separate tracking)
    progress: {
      1: { streak: 0, stars: 0 },
      2: { streak: 0, stars: 0 },
      3: { streak: 0, stars: 0 },
    },

    a: 0,
    b: 0,
    answer: 0,
    lastKey: null,

    tensCoins: 0,
    onesCoins: 0,

    borrowNeeded: false,
    borrowDone: false,
    bankHasTen: false,
    bankExchanged: false,
    borrowedToOnes: false,

    gradingLocked: false,
    overlayOpen: false
  };

  function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function digits(n){ return {tens: Math.floor(n/10), ones: n%10}; }
  function clampDigitInput(el){
    el.value = el.value.replace(/[^0-9]/g, "");
    if (el.value.length > 1) el.value = el.value.slice(0,1);
  }

  function getProg(){
    return state.progress[state.level];
  }

  function renderStars(){
    const max = 5;
    const { stars } = getProg();
    let html = "";
    for (let i=0;i<max;i++){
      html += `<span class="${i < stars ? "" : "off"}">★</span>`;
    }
    starsEl.innerHTML = html;
  }

  function updateHeader(){
    whoEl.textContent = state.studentName || "—";
    levelInGameEl.value = String(state.level);

    const { streak } = getProg();
    streakEl.textContent = String(streak);

    renderStars();
  }

  function needsBorrow(a, b){
    const da = digits(a), db = digits(b);
    return da.ones < db.ones;
  }

  const praise = ["Godt klaret", "Flot arbejde", "Super", "Stærkt", "Rigtig godt"];
  function praiseLine(name){
    return `${praise[randInt(0, praise.length-1)]}, ${name}!`;
  }

  // --------- Problem lifecycle ----------
  function makeProblem(){
    // HARD cleanup of any leftover flying coins
    document.querySelectorAll(".flying-coin").forEach(el => el.remove());

    let a, b, key;
    let attempts = 0;
    while (true){
      attempts++;
      if (attempts > 5000){ a = 50; b = 23; break; }

      a = randInt(23, 99);

      if (state.level === 1){
        const da = digits(a);
        const bt = randInt(0, da.tens);
        const bo = randInt(0, da.ones);
        b = bt*10 + bo;
        if (b === 0) continue;
        key = `${a}-${b}`;
        if (key === state.lastKey) continue;
        break;
      }

      b = randInt(23, a);
      key = `${a}-${b}`;
      if (key === state.lastKey) continue;
      break;
    }

    state.a = a;
    state.b = b;
    state.answer = a - b;
    state.lastKey = `${a}-${b}`;

    const da = digits(a);
    state.tensCoins = da.tens;
    state.onesCoins = da.ones;

    state.borrowNeeded = needsBorrow(a, b);
    state.borrowDone = false;
    state.bankHasTen = false;
    state.bankExchanged = false;
    state.borrowedToOnes = false;

    state.gradingLocked = false;

    // Reset UI state
    bankSlotEl.innerHTML = "";
    bankStatusEl.textContent = "Ingen veksling endnu.";
    exchangeBtn.disabled = true;

    // Remove strike on new problem
    aTensEl.classList.remove("struck");

    ansTensEl.value = "";
    ansOnesEl.value = "";

    // Focus right-most input every time
    queueMicrotask(() => ansOnesEl.focus());

    renderProblem();
    renderCoins();     // coins reset each new problem
    updateAnswerBtn();
  }

  function renderProblem(){
    updateHeader();

    const da = digits(state.a);
    const db = digits(state.b);

    aTensEl.textContent = da.tens;
    aOnesEl.textContent = da.ones;
    bTensEl.textContent = db.tens;
    bOnesEl.textContent = db.ones;

    borrowOnesMarkEl.textContent = state.borrowedToOnes ? "10" : "";

    tensCountEl.textContent = `${state.tensCoins} stk`;
    onesCountEl.textContent = `${state.onesCoins} stk`;

    if (state.level === 1){
      bankRulesEl.textContent = "Niveau 1: Ingen lån. Bank er slået fra i denne opgave.";
    } else if (!state.borrowNeeded){
      bankRulesEl.textContent = "Der er ikke behov for lån i denne opgave.";
    } else {
      bankRulesEl.textContent = "Der er behov for lån (enere). Træk en 10'er i banken og tryk Veksel.";
    }

    exchangeBtn.disabled = !canExchangeNow();
  }

  function renderCoins(){
    tensPileEl.innerHTML = "";
    onesPileEl.innerHTML = "";

    for (let i=0;i<state.tensCoins;i++){
      const c = document.createElement("div");
      c.className = "coin tens";
      c.textContent = "10";
      c.setAttribute("draggable", "true");

      c.addEventListener("click", () => {
        if (state.gradingLocked || state.overlayOpen) return;
        c.classList.toggle("crossed");
      });

      c.addEventListener("dragstart", (e) => {
        if (!canDropTenToBank() || state.overlayOpen) { e.preventDefault(); return; }
        e.dataTransfer.setData("text/plain", "TEN_COIN");
      });

      tensPileEl.appendChild(c);
    }

    for (let i=0;i<state.onesCoins;i++){
      const c = document.createElement("div");
      c.className = "coin ones";
      c.textContent = "1";
      c.addEventListener("click", () => {
        if (state.gradingLocked || state.overlayOpen) return;
        c.classList.toggle("crossed");
      });
      onesPileEl.appendChild(c);
    }
  }

  // --------- Bank logic ----------
  function canDropTenToBank(){
    if (state.level === 1) return false;
    if (!state.borrowNeeded) return false;
    if (state.borrowDone) return false;
    if (state.bankHasTen) return false;
    if (state.tensCoins <= 0) return false;
    return true;
  }

  function canExchangeNow(){
    if (state.level === 1) return false;
    if (!state.borrowNeeded) return false;
    if (state.borrowDone) return false;
    if (!state.bankHasTen) return false;
    if (state.bankExchanged) return false;
    return true;
  }

  function placeTenInBank(){
    if (!canDropTenToBank() || state.overlayOpen) return;

    // Strike tens digit when borrowing begins
    aTensEl.classList.add("struck");

    state.tensCoins -= 1;
    state.bankHasTen = true;

    bankSlotEl.innerHTML = "";
    const ten = document.createElement("div");
    ten.className = "coin tens";
    ten.textContent = "10";
    bankSlotEl.appendChild(ten);

    bankStatusEl.textContent = "10'er sat i banken. Tryk Veksel.";
    renderProblem();
    renderCoins();
  }

  async function exchangeInBank(){
    if (!canExchangeNow() || state.overlayOpen) return;

    state.bankExchanged = true;
    state.borrowDone = true;
    state.borrowedToOnes = true;

    bankStatusEl.textContent = "Veksler… 10 → 10×1 (i banken)";
    exchangeBtn.disabled = true;

    // Create 10 ones in bank
    bankSlotEl.innerHTML = "";
    const bankOnes = [];
    for (let i=0;i<10;i++){
      const c = document.createElement("div");
      c.className = "coin ones";
      c.textContent = "1";
      bankSlotEl.appendChild(c);
      bankOnes.push(c);
    }

    await wait(2000);
    await animateBankOnesToOnesPile(bankOnes);

    // Apply result and reset bank
    state.onesCoins += 10;
    state.bankHasTen = false;

    bankSlotEl.innerHTML = "";
    bankStatusEl.textContent = "Veksling færdig: 10 enere flyttet til enere.";
    renderProblem();
    renderCoins();
    updateAnswerBtn();
  }

  function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

  // Reliable animation: Web Animations API + hard cleanup
  function createFlyingCoin(start, end){
    const d = document.createElement("div");
    d.className = "coin ones flying-coin";
    d.style.left = start.x + "px";
    d.style.top  = start.y + "px";

    const dx = end.x - start.x;
    const dy = end.y - start.y;

    document.body.appendChild(d);

    const anim = d.animate(
      [
        { transform: "translate(0px, 0px)", opacity: 1 },
        { transform: `translate(${dx}px, ${dy}px)`, opacity: 1 }
      ],
      { duration: 650, easing: "ease-in-out", fill: "forwards" }
    );

    const hard = setTimeout(() => d.remove(), 1200);

    return anim.finished
      .catch(() => {})
      .finally(() => {
        clearTimeout(hard);
        d.remove();
      });
  }

  function getRectPage(el){
    const r = el.getBoundingClientRect();
    return { x: r.left + window.scrollX, y: r.top + window.scrollY };
  }

  function readPileLayout(){
    const cs = getComputedStyle(onesPileEl);
    const gap = parseFloat(cs.gap || "8") || 8;
    const cols = 5;
    const colWidth = 40;
    return { cols, gap, colWidth, cell: colWidth + gap };
  }

  async function animateBankOnesToOnesPile(bankOnesEls){
    const pileRect = getRectPage(onesPileEl);
    const { cols, cell } = readPileLayout();

    const startIndex = state.onesCoins; // BEFORE adding 10

    const tasks = [];
    for (let i=0;i<bankOnesEls.length;i++){
      const start = getRectPage(bankOnesEls[i]);

      const idx = startIndex + i;
      const col = idx % cols;
      const row = Math.floor(idx / cols);

      const end = {
        x: pileRect.x + 6 + col * cell,
        y: pileRect.y + 6 + row * cell
      };

      tasks.push(createFlyingCoin(start, end));
    }

    bankOnesEls.forEach(el => el.style.visibility = "hidden");
    await Promise.all(tasks);
  }

  // Drag/drop bank
  bankDropEl.addEventListener("dragover", (e) => {
    e.preventDefault();
    if (canDropTenToBank() && !state.overlayOpen) bankDropEl.classList.add("dragover");
  });
  bankDropEl.addEventListener("dragleave", () => bankDropEl.classList.remove("dragover"));
  bankDropEl.addEventListener("drop", (e) => {
    e.preventDefault();
    bankDropEl.classList.remove("dragover");
    const payload = e.dataTransfer.getData("text/plain");
    if (payload === "TEN_COIN") placeTenInBank();
  });

  exchangeBtn.addEventListener("click", exchangeInBank);

  // --------- Answer button + Enter support ----------
  function updateAnswerBtn(){
    if (state.gradingLocked || state.overlayOpen) { answerBtn.disabled = true; return; }

    const onesFilled = ansOnesEl.value !== "";
    if (!onesFilled) { answerBtn.disabled = true; return; }

    const needsTens = (state.answer >= 10);
    if (needsTens && ansTensEl.value === "") { answerBtn.disabled = true; return; }

    answerBtn.disabled = false;
  }

  ansOnesEl.addEventListener("input", () => {
    if (state.overlayOpen) return;
    clampDigitInput(ansOnesEl);
    if (ansOnesEl.value.length === 1) ansTensEl.focus();
    updateAnswerBtn();
  });
  ansTensEl.addEventListener("input", () => {
    if (state.overlayOpen) return;
    clampDigitInput(ansTensEl);
    updateAnswerBtn();
  });

  function parseGivenAnswer(){
    const tens = ansTensEl.value === "" ? 0 : Number(ansTensEl.value);
    const ones = ansOnesEl.value === "" ? 0 : Number(ansOnesEl.value);
    return tens*10 + ones;
  }

  function showOverlay(ok, correctAnswer){
    const name = state.studentName || "Elev";
    if (ok){
      modalTitleEl.innerHTML = `<span class="good">${praiseLine(name)}</span>`;
      modalTextEl.textContent = `${state.a} − ${state.b} = ${correctAnswer}`;
      modalSubEl.textContent = "Du er klar til næste opgave.";
    } else {
      modalTitleEl.innerHTML = `<span class="bad">Ikke helt, ${name}.</span>`;
      modalTextEl.innerHTML = `Rigtigt svar: <strong>${correctAnswer}</strong>`;
      modalSubEl.textContent = "Prøv igen på næste opgave.";
    }
    state.overlayOpen = true;
    overlayEl.classList.add("show");
    overlayEl.setAttribute("aria-hidden", "false");
    // Put focus on the modal button so Enter naturally activates it
    queueMicrotask(() => modalBtn.focus());
  }

  function hideOverlay(){
    overlayEl.classList.remove("show");
    overlayEl.setAttribute("aria-hidden", "true");
    state.overlayOpen = false;
  }

  // KEY FIX: global key handler to route Enter to modal when overlay is open
  document.addEventListener("keydown", (e) => {
    if (!state.overlayOpen) return;

    if (e.key === "Enter") {
      e.preventDefault();
      e.stopPropagation();
      modalBtn.click();
    }
  }, true);

  answerBtn.addEventListener("click", () => {
    if (answerBtn.disabled || state.overlayOpen) return;

    state.gradingLocked = true;

    const given = parseGivenAnswer();
    const correct = state.answer;
    const ok = (given === correct);

    const prog = getProg();
    if (ok){
      prog.streak += 1;
      if (prog.streak % 5 === 0 && prog.stars < 5) prog.stars += 1;
    } else {
      prog.streak = 0; // stars remain
    }

    updateHeader();
    showOverlay(ok, correct);
  });

  modalBtn.addEventListener("click", () => {
    hideOverlay();
    makeProblem();
  });

  // Also allow Enter to submit while typing (but NOT when overlay is open)
  function trySubmitWithEnter(e){
    if (state.overlayOpen) return;
    if (e.key !== "Enter") return;
    e.preventDefault();
    if (!answerBtn.disabled) answerBtn.click();
  }
  ansOnesEl.addEventListener("keydown", trySubmitWithEnter);
  ansTensEl.addEventListener("keydown", trySubmitWithEnter);

  // --------- In-game level switching (separate streak/stars per level) ----------
  applyLevelBtn.addEventListener("click", () => {
    if (state.overlayOpen) return;
    const newLevel = Number(levelInGameEl.value);
    if (newLevel === state.level) return;

    state.level = newLevel;

    updateHeader();
    makeProblem();
  });

  levelInGameEl.addEventListener("change", () => applyLevelBtn.click());

  // --------- Start/reset ----------
  function startApp(){
    state.studentName = studentNameEl.value.trim() || "Elev";
    state.level = Number(levelEl.value);

    setup.classList.add("hidden");
    app.classList.remove("hidden");

    updateHeader();
    makeProblem();
  }

  startBtn.addEventListener("click", startApp);
  studentNameEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") startApp();
  });

  newStudentBtn.addEventListener("click", () => {
    // Keep per-level progress for this session; only return to setup screen.
    app.classList.add("hidden");
    setup.classList.remove("hidden");
    ansTensEl.value = "";
    ansOnesEl.value = "";
    studentNameEl.focus();
  });

  renderStars();
})();
</script>
</body>
</html>
